<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.phlink.bus.api.trajectory.dao.TrajectoryMapper">

    <select id="listTrajectorys" resultType="com.phlink.bus.api.trajectory.domain.Trajectory">
        select t.*
        from t_trajectory t
        where t.deleted=false
        <if test="trajectoryVO.numberPlate!=null and trajectoryVO.numberPlate!=''">
            and t.number_plate like CONCAT('%', #{trajectoryVO.numberPlate}, '%')
        </if>
        <if test="trajectoryVO.busCode!=null and trajectoryVO.busCode!=''">
            and t.bus_code like CONCAT('%', #{trajectoryVO.busCode}, '%')
        </if>
        <if test="trajectoryVO.startTime!=null and trajectoryVO.startTime!=''">
            and t.create_time <![CDATA[ >= ]]> to_timestamp(#{trajectoryVO.startTime})
        </if>
        <if test="trajectoryVO.endTime!=null and trajectoryVO.endTime!=''">
            and t.create_time <![CDATA[ <= ]]> to_timestamp(#{trajectoryVO.endTime})
        </if>
        <if test="trajectoryVO.busId!=null">
            and t.bus_id = #{trajectoryVO.busId}
        </if>
        order by t.id desc
    </select>
    <select id="getByBusIdOnTrip" resultType="com.phlink.bus.api.trajectory.domain.Trajectory">
        select tr.*
        from t_trajectory tr
                    left join t_trip_log tl on tr.trip_log_id = tl.id and tl.deleted = false
        where tl.state = '1'
          and tr.deleted = false
          and tr.bus_id = #{busId}
          and tl.time = CURRENT_DATE
        order by tr.create_time desc
        limit 1

    </select>
    <select id="getByBusIdOnBindRoute" resultType="com.phlink.bus.api.trajectory.domain.Trajectory">
        select tr.*
        from t_trajectory tr
        left join t_route_operation ro on ro.bind_bus_id = tr.tid and ro.deleted = false
        where tr.deleted = false
        and ro.bind_bus_id = #{busId}
        limit 1
    </select>
</mapper>
